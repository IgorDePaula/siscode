(function(e,g,i,h,b,c){var d=window.App||(window.App={}),f="click",a=navigator.userAgent.match(/mobile/i);if(a&&"ontouchstart" in document.documentElement){f="touchstart"}d.SavedModel=g.Model.extend({defaults:{url:null,name:null},sync:function(p,l,k){var m,n,o,j;if(p==="create"){m=b.store("savedCombinations");if(!m){m=[]}n=this.toJSON();n.id=i.uniqueId();m.push(n);b.store("savedCombinations",m);k.success(n)}else{if(p==="delete"){o=l.get("id");m=b.store("savedCombinations",m);j=null;i.each(m,function(r,q){if(r.id===o){j=q;return false}});if(j!==null){m.splice(j,1)}b.store("savedCombinations",m)}else{if(p==="update"){o=l.get("id");m=b.store("savedCombinations",m);j=null;i.each(m,function(r,q){if(r.id===o){m[q]=l.toJSON();return false}});b.store("savedCombinations",m)}}}},clear:function(){this.destroy()}});d.SavedView=g.View.extend({tagName:"li",router:null,editMode:false,template:h.compile(e("#foot-bar-combination-tmpl").html()),initialize:function(j){this.router=j.router;this.webroot=j.webroot;this.model.on("destroy",this.remove,this);this.model.on("change:name",this.render,this)},events:function(){var j={};j[f+" a"]="goToSavedUrl";j[f+" .foot-bar-remove"]="removeCombination";j[f+" .foot-bar-edit"]="editCombination";j["keypress input"]="updateCombination";return j},editCombination:function(){if(this.editMode){this.update()}else{this.editMode=true;this.$(".foot-bar-combination-name").hide();this.$("input").show().focus().select()}return false},updateCombination:function(j){if(j.keyCode===13){this.update()}},update:function(){var j;this.$(".foot-bar-combination-name").show();j=this.$("input").hide().val();this.model.save({name:j});this.editMode=false;window.woopraTracker.pushEvent({name:"edit",url:window.location.origin+this.webroot+"c/"+this.model.get("url"),title:j})},removeCombination:function(){window.woopraTracker.pushEvent({name:"delete",url:window.location.origin+this.webroot+"c/"+this.model.get("url"),title:this.model.get("name")});this.model.clear();return false},goToSavedUrl:function(){this.router.navigate("c/"+this.model.get("url"),{trigger:true});return false},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});d.SavedCollection=g.Collection.extend({model:d.SavedModel,sync:function(m,l,j){if(m==="read"){var k=b.store("savedCombinations");j.success(k)}}});d.SavedCollectionView=g.View.extend({el:".foot-bar",toggled:false,router:null,webroot:null,courseCollection:null,collection:new d.SavedCollection(),events:function(){var j=a?{"touchstart .foot-bar-toggle":"toggleFoot","touchstart .foot-bar-add":"save"}:{"click .foot-bar-toggle":"toggleFoot","click .foot-bar-add":"save"};return j},initialize:function(j){this.router=j.router;this.webroot=j.webroot;this.courseCollection=j.courseCollection;this.collection.on("add",this.addOne,this);this.collection.on("reset",this.addAll,this);this.collection.fetch({reset:true})},addAll:function(k){var j=this;i.each(k.models,function(l){j.addSaved(l,true)})},addOne:function(j){this.addSaved(j)},addSaved:function(k,m){var j,l;j=new d.SavedView({router:this.router,webroot:this.webroot,model:k});j.render();l=j.$el;this.$(".foot-bar-combination").prepend(l);if(!m){j.editCombination();if(!this.toggled){this.toggleFoot()}}},toggleFoot:function(){var j;j=this.$(".foot-bar-arrow");if(this.toggled===false){this.$el.addClass("toggled");j.addClass("down");this.toggled=true}else{this.$el.removeClass("toggled");j.removeClass("down");this.toggled=false}return false},crnHash:function(){var k,j=[];i.each(this.courseCollection.models,function(l){j.push("--"+l.get("crn"))});k=[this.router.institution.id,1,this.router.days.join("-"),j.join("_")].join("_");return k},save:function(){if(this.collection.where({url:this.router.url}).length===0&&this.router.url.length!==0){var j="";i.each(this.courseCollection.models,function(k,l){if(l!==0){j+=" - "}j+=k.get("crn")+" ("+k.get("subject_code")+" "+k.get("number")+")"});window.woopraTracker.pushEvent({name:"save",url:window.location.href,title:j});this.collection.create({url:this.crnHash(),name:j})}}})}(jQuery,Backbone,_,Handlebars,amplify));