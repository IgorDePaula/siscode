(function(e,g,i,h,b,c){var d=window.App||(window.App={}),f="click",a=navigator.userAgent.match(/mobile/i);if(a&&"ontouchstart" in document.documentElement){f="touchstart"}d.InstitutionModel=g.Model.extend();d.InstitutionCollection=g.Collection.extend({model:d.InstitutionModel});d.InstitutionListView=g.View.extend({template:h.compile(e("#institutions-select").html()),events:{"change select[name=institution_id]":"institutionChanged"},institutionChanged:function(){var k,j;k=this.$("select[name=institution_id]").val();if(k){j=this.collection.get(k).toJSON()}else{j={subjects:[]}}this.trigger("institutionChanged",j)},initialize:function(j){this.collection=new d.InstitutionCollection(j.institutions);this.collection.on("reset",this.render,this)},selectInstitution:function(j){this.$("select[name=institution_id]").val(j).trigger("change").trigger("chosen:updated")},render:function(){this.$el.html(this.template({institutions:this.collection.toJSON()}));return this},afterRender:function(){this.$("select").chosen()}});d.SubjectModel=g.Model.extend();d.SubjectCollection=g.Collection.extend({model:d.SubjectModel});d.CourseInputModel=g.Model.extend();d.CourseInputView=g.View.extend({tagName:"div",className:"cil-course-input",template:h.compile(e("#course-input-tmpl").html()),numberTemplate:h.compile(e("#course-input-numbers").html()),subjectCollection:null,events:{"change select[name=subject_id]":"fillNumber","click .cil-remove-course":"removeCourse","keyup .cil-course-crn":"crnKeyUp"},initialize:function(j){this.subjectCollection=new d.SubjectCollection(j.subjects);this.model.on("remove",this.remove,this)},crnKeyUp:function(j){if(this.$(j.target).val().length>0){this.$("select").prop("disabled",true).trigger("chosen:updated")}else{this.$("select").prop("disabled",false).trigger("chosen:updated")}},fillNumber:function(){var l,k,j;l=this.$("select[name=subject_id]").val();if(l){j=this.subjectCollection.get(l).toJSON()}else{j={numbers:[]}}this.$("select[name=number]").html(this.numberTemplate(j)).trigger("chosen:updated")},render:function(){var j,k=this.model.toJSON();k.subjects=this.subjectCollection.toJSON();this.$el.html(this.template(k)).find("select[name=subject_id]").val(this.model.get("subject_id")).trigger("change").end().find("select[name=number]").val(this.model.get("number"));return this},afterRender:function(){this.$("select").chosen()},removeCourse:function(){this.model.destroy()}});d.CourseInputCollection=g.Collection.extend({model:d.CourseInputModel});d.CourseInputListView=g.View.extend({el:".cil",institutionListView:null,collection:new d.CourseInputCollection(),institution:null,closed:false,events:{"keypress .course-input":"keyLog"},keyLog:function(j){if(j.keyCode===13){this.updateUrlEvent()}},initialize:function(j){this.router=j.router;this.initInstitutionListView(j);this.afterRender();this.collection.on("add",this.addInput,this);this.collection.on("reset",this.collectionReset,this);this.router.on("urlChanged",this.dehasherize,this)},initInstitutionListView:function(k){var j=new d.InstitutionListView({institutions:k.institutions});this.$(".cil-institutions").html(j.render().$el);j.afterRender();j.on("institutionChanged",this.institutionChanged,this);this.institutionListView=j;this.institutionChanged()},institutionChanged:function(j){this.institution=j;this.collection.reset();if(this.institution!==null){this.$(".cil-add-course").show()}else{this.$(".cil-add-course").hide()}},collectionReset:function(k,j){i.each(j.previousModels,function(l){l.trigger("remove")});this.closeInputs()},closeInputs:function(){this.$el.addClass("cil-hidden");e("body").addClass("cil-hidden")},openInputs:function(){this.$el.removeClass("cil-hidden");e("body").removeClass("cil-hidden")},addInput:function(k){var j;j=new d.CourseInputView({model:k,subjects:this.institution.subjects});j.render();this.$(".cil-courses").append(j.$el);j.afterRender()},afterRender:function(){var j=this;this.$(".cil-add-course").on("click",function(){j.addInputModel()});this.$(".cil-submit").on("click",function(){j.updateUrlEvent()});this.$(".cil-expand-arrow").on(f,function(){j.openInputs();return false});return this},addInputModel:function(){this.collection.add(new d.CourseInputModel())},updateUrlEvent:function(){this.updateUrl();this.closeInputs()},updateUrl:function(k){var j=this.getProps();this.router.handleUrl({page:1,institution:this.institution,days:j.days,courses:j.courses})},getProps:function(){var j=[],k=[];this.$(".cil-course-input").each(function(){j.push({subject:e(this).find("select[name=subject_id]").val(),number:e(this).find("select[name=number]").val(),crn:e(this).find("input[name=crn]").val()})});e('input[name^="filter"]').each(function(){if(e(this).prop("checked")){k.push(e(this).val())}});return{courses:j,days:k}},dehasherize:function(o){var n=[],q,p,m,l,j=this,k;n=o.split("_");l=n.splice(0,1)[0];m=n.splice(0,1)[0];p=n.splice(0,1)[0].split("-");this.institutionListView.selectInstitution(l);this.updateFilters(p);this.collection.reset();i.each(n,function(r,s){q=r.split("-");j.collection.add(new d.CourseInputModel({subject_id:q[0],number:q[1],crn:q[2]}))});k=this.getProps();this.router.updateProps({page:m,institution:this.institution,days:k.days,courses:k.courses})},updateFilters:function(l){var j=this.$('input[name^="filter"]'),k=this;j.prop("checked",false);i.each(l,function(m){k.$('input[name="filter['+m+']"]').prop("checked",true)})}})}(jQuery,Backbone,_,Handlebars,amplify));